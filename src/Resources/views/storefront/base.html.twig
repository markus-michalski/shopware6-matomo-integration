{% sw_extends '@Storefront/storefront/base.html.twig' %}

{# Inject Matomo tracking code before closing body tag #}
{% block base_body_script %}
    {{ parent() }}

    {% if matomoConfig is defined and matomoConfig.enabled %}
        {% if matomoConfig.useKlaroConsent %}
            {# Klaro Consent Mode: Script is blocked until user consents #}
            {# The data-name attribute tells Klaro which service this script belongs to #}
            <script type="text/plain"
                    data-type="text/javascript"
                    data-name="{{ matomoConfig.klaroServiceName }}">
                {{ matomoTrackingCode|raw }}
            </script>

            {# E-Commerce tracking (also needs consent) #}
            {% if page.extensions.matomoEcommerce is defined %}
                {% set ecommerce = page.extensions.matomoEcommerce %}
                {% if ecommerce.trackingCode %}
                    <script type="text/plain"
                            data-type="text/javascript"
                            data-name="{{ matomoConfig.klaroServiceName }}">
                        {{ ecommerce.trackingCode|raw }}
                    </script>
                {% endif %}
            {% endif %}

            {# Klaro consent change handler - grants/revokes Matomo consent #}
            <script>
                (function() {
                    var serviceName = '{{ matomoConfig.klaroServiceName }}';
                    var consentGranted = false;

                    function handleConsent(granted) {
                        if (typeof window._paq === 'undefined') {
                            return;
                        }

                        if (granted && !consentGranted) {
                            _paq.push(['setConsentGiven']);
                            consentGranted = true;
                        } else if (!granted && consentGranted) {
                            _paq.push(['forgetConsentGiven']);
                            consentGranted = false;
                        }
                    }

                    // Listen for consent changes
                    window.addEventListener('klaro-consent-change', function(e) {
                        var consents = e.detail.consents || {};
                        handleConsent(consents[serviceName] === true);
                    });

                    // Check initial consent state when Klaro is ready
                    function checkInitialConsent() {
                        if (typeof window.klaro !== 'undefined' && typeof window.klaro.getManager === 'function') {
                            var manager = window.klaro.getManager();
                            if (manager && typeof manager.getConsent === 'function') {
                                handleConsent(manager.getConsent(serviceName) === true);
                            }
                        }
                    }

                    // Try immediately and also after DOM is ready
                    if (document.readyState === 'complete') {
                        setTimeout(checkInitialConsent, 100);
                    } else {
                        window.addEventListener('load', function() {
                            setTimeout(checkInitialConsent, 100);
                        });
                    }
                })();
            </script>
        {% else %}
            {# Standard mode: Scripts load immediately #}
            {% if matomoTrackingCode is defined and matomoTrackingCode %}
                <script>
                    {{ matomoTrackingCode|raw }}
                </script>
            {% endif %}

            {# E-Commerce tracking code (product view, cart, order) #}
            {% if page.extensions.matomoEcommerce is defined %}
                {% set ecommerce = page.extensions.matomoEcommerce %}
                {% if ecommerce.trackingCode %}
                    <script>
                        {{ ecommerce.trackingCode|raw }}
                    </script>
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}
{% endblock %}
